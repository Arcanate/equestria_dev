SM_calculate_bonus_ponypower_percentage = {
	set_temp_variable = { SM_conscription_percentage_temp_var = 1 }
	add_to_temp_variable = { SM_conscription_percentage_temp_var = modifier@conscription_factor }
	multiply_temp_variable = { SM_conscription_percentage_temp_var = modifier@conscription }
	
	if = {
		limit = {
			any_of_scopes = {
				array = owned_controlled_states
				
				NOT = { is_core_of = ROOT }
			}
		}
		
		set_temp_variable = { SM_non_core_conscription_percentage_temp_var = 1 }
		add_to_temp_variable = { SM_non_core_conscription_percentage_temp_var = modifier@conscription_factor }
		multiply_temp_variable = { SM_non_core_conscription_percentage_temp_var = modifier@non_core_manpower }
	}
	
	for_each_scope_loop = {
		array = owned_controlled_states
		
		if = {
			limit = {
				is_core_of = ROOT
			}
			
			if = {
				limit = {
					check_variable = {
						var = modifier@local_manpower
						compare = not_equals
						value = 0
					}
				}
				
				set_temp_variable = { SM_state_conscriptors_temp_var = 1 }
				add_to_temp_variable = { SM_state_conscriptors_temp_var = modifier@local_manpower }
				multiply_temp_variable = { SM_state_conscriptors_temp_var = ROOT.SM_conscription_percentage_temp_var }
			}
			else = {
				set_temp_variable = { SM_state_conscriptors_temp_var = ROOT.SM_conscription_percentage_temp_var }
			}
		}
		else = {
			if = {
				limit = {
					check_variable = {
						var = modifier@local_non_core_manpower
						compare = not_equals
						value = 0
					}
				}
				
				set_temp_variable = { SM_state_conscriptors_temp_var = 1 }
				add_to_temp_variable = { SM_state_conscriptors_temp_var = modifier@local_non_core_manpower }
				multiply_temp_variable = { SM_state_conscriptors_temp_var = ROOT.SM_non_core_conscription_percentage_temp_var }
			}
			else = {
				set_temp_variable = { SM_state_conscriptors_temp_var = ROOT.SM_non_core_conscription_percentage_temp_var }
			}
		}
		
		multiply_temp_variable = { SM_state_conscriptors_temp_var = state_population_k }
		add_to_variable = { ROOT.SM_manpower_k_from_conscription_var = SM_state_conscriptors_temp_var }
	}
	
	set_variable = { SM_bonus_consciptors_percentage_var = SM_manpower_k_from_conscription_var }
	divide_variable = { SM_bonus_consciptors_percentage_var = manpower_k }
}